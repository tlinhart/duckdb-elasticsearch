# This workflow builds the extension and runs the complete test suite including
# integration tests.
name: Extension tests
on:
  push:
  pull_request:
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref || '' }}-${{ github.base_ref || '' }}-${{ github.ref != 'refs/heads/main' && github.sha || '' }}
  cancel-in-progress: true
jobs:
  tests:
    name: Run all tests
    runs-on: ubuntu-latest
    services:
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.17.0
        env:
          discovery.type: single-node
          xpack.security.enabled: true
          xpack.ml.enabled: false
          ELASTIC_PASSWORD: test
          ES_JAVA_OPTS: -Xms512m -Xmx512m
        ports:
          - 9200:9200
        options: >-
          --memory=1g
          --health-cmd="curl -s -u elastic:test http://localhost:9200/_cluster/health | grep -qE 'green|yellow'"
          --health-interval=10s
          --health-timeout=10s
          --health-retries=30
          --health-start-period=60s
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@main
        with:
          key: ${{ github.job }}
          save: ${{ github.ref == 'refs/heads/main' }}
      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11.1
        with:
          # Match the commit used by extension-ci-tools workflows.
          vcpkgGitCommitId: ce613c41372b23b1f51333815feb3edd87ef8a8b
      - name: Build extension binaries
        env:
          VCPKG_TOOLCHAIN_PATH: ${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake
          VCPKG_TARGET_TRIPLET: x64-linux
          GEN: ninja
        run: make release
      - name: Setup Elasticsearch
        run: ./test/setup-elasticsearch.sh
      - name: Run tests
        run: make test
        env:
          ELASTICSEARCH_TEST_SERVER_AVAILABLE: 1
