# name: test/sql/geospatial.test
# description: Test geo types handling, GeoJSON conversion and geospatial queries
# group: [sql]

require elasticsearch

require-env ELASTICSEARCH_TEST_SERVER_AVAILABLE

# Test geo_point with object format ({"lat": 40.7128, "lon": -74.006}).
query I
SELECT location FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE _id = '1';
----
{"type":"Point","coordinates":[-74.006,40.7128]}

# Test geo_point with string format ("51.5074,-0.1278").
query I
SELECT location FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE _id = '2';
----
{"type":"Point","coordinates":[-0.1278,51.5074]}

# Test geo_point with array format ([-118.2437, 34.0522]).
query I
SELECT location FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE _id = '3';
----
{"type":"Point","coordinates":[-118.2437,34.0522]}

# Test geo_point with WKT format ("POINT (139.6917 35.6895)").
query I
SELECT location FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE _id = '4';
----
{"type":"Point","coordinates":[139.6917,35.6895]}

# Test geo_shape Point.
query I
SELECT geometry FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE _id = '1';
----
{"type":"Point","coordinates":[-122.4194,37.7749]}

# Test geo_shape LineString.
query I
SELECT geometry FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE _id = '2';
----
{"type":"LineString","coordinates":[[-73.9857,40.7484],[-73.9851,40.7479],[-73.9845,40.7475]]}

# Test geo_shape Polygon.
query I
SELECT geometry FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE _id = '3';
----
{"type":"Polygon","coordinates":[[[-0.1357,51.5194],[-0.1197,51.5194],[-0.1197,51.5094],[-0.1357,51.5094],[-0.1357,51.5194]]]}

# Test geo_shape MultiPoint.
query I
SELECT geometry FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE _id = '4';
----
{"type":"MultiPoint","coordinates":[[2.3522,48.8566],[2.3488,48.8534],[2.3555,48.8601]]}

statement ok
INSTALL spatial;

statement ok
LOAD spatial;

# Test deserialization from GeoJSON to GEOMETRY type (geo_point field).
query I
SELECT ST_GeomFromGeoJSON(location) FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE _id = '3';
----
POINT (-118.2437 34.0522)

# Test deserialization from GeoJSON to GEOMETRY type (geo_shape field).
query I
SELECT ST_GeomFromGeoJSON(geometry) FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE _id = '4';
----
MULTIPOINT (2.3522 48.8566, 2.3488 48.8534, 2.3555 48.8601)

# Test geo_bounding_box query via ST_Within on geo_point field.
query I
SELECT name FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE ST_Within(ST_GeomFromGeoJSON(location), ST_MakeEnvelope(-1, 33, 0, 52));
----
Michael Brown

# Test geo_bounding_box query via ST_Contains on geo_point field (reversed arguments).
query I
SELECT name FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE ST_Contains(ST_MakeEnvelope(-1, 33, 0, 52), ST_GeomFromGeoJSON(location));
----
Michael Brown

# Test geo_shape intersects query with geo_shape field.
query I
SELECT name FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE ST_Intersects(ST_GeomFromGeoJSON(geometry), ST_Point(-122.4194, 37.7749));
----
Alice Johnson

# Test geo_shape intersects query with geo_shape field on second argument position (symmetric).
query I
SELECT name FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE ST_Intersects(ST_Point(-122.4194, 37.7749), ST_GeomFromGeoJSON(geometry));
----
Alice Johnson

# Test geo_shape contains query: geo_shape field contains a point.
query I
SELECT name FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE ST_Contains(ST_GeomFromGeoJSON(geometry), ST_Point(-0.13, 51.51));
----
Emma Wilson

# Test geo_shape within query: point within a geo_shape field (reversed arguments).
query I
SELECT name FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE ST_Within(ST_Point(-0.13, 51.51), ST_GeomFromGeoJSON(geometry));
----
Emma Wilson

# Test geo_shape within query: geo_shape field within a large bounding polygon.
query I
SELECT name FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE ST_Within(ST_GeomFromGeoJSON(geometry), ST_GeomFromGeoJSON('{"type":"Polygon","coordinates":[[[-123,37],[-122,37],[-122,38],[-123,38],[-123,37]]]}'));
----
Alice Johnson

# Test geo_shape disjoint query.
query I rowsort
SELECT name FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE ST_Disjoint(ST_GeomFromGeoJSON(geometry), ST_Point(12.4964, 41.9028));
----
Alice Johnson
Benjamin Lee
Charlotte Anderson
Daniel Taylor
Emma Wilson
James Garcia
Michael Brown
Olivia Davis
William Thompson

# Test combination of geospatial and regular filter.
query I
SELECT name FROM elasticsearch_query(
    host := 'localhost',
    index := 'test',
    username := 'elastic',
    password := 'test'
)
WHERE ST_Within(ST_GeomFromGeoJSON(location), ST_MakeEnvelope(-10, 30, 10, 55)) AND
      amount < 90;
----
Michael Brown
